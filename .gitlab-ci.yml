stages:
  - test
  - publish

variables: # TODO(template) update these if you have go submodules
  MAJOR_VERSION: "0"
  MINOR_VERSION: "0"
  TAG_PREFIX: ""

test_and_lint:
  stage: test
  image: golang:1.16
  cache:
    paths:
      - .cache/
  before_script:
    - go env -w "GOPRIVATE=${CI_SERVER_HOST}"
    - echo -e "machine ${CI_SERVER_HOST} login gitlab-ci-token password ${CI_JOB_TOKEN}" > ~/.netrc
  script:
    # set $GOPATH into current directory so we can cache it between runs
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - export PATH=$PATH:$GOPATH/bin
    # run unit tests and linters
    - make ci
    # generate code navigation artifact for gitlab.com
    - make lsif
    # TODO(template) update these if you have go submodules (see variables)
    - ./scripts/tag_semver.sh $MAJOR_VERSION $MINOR_VERSION "$TAG_PREFIX"
  coverage: '/^total:\t+\(statements\)\t+(\d+\.\d+)%/'
  artifacts:
    reports:
      lsif: dump.lsif
      dotenv: variables.env
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_TAG'

tag_semver:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: test_and_lint
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH' 
  script:
    - echo 'releasing new version'
  release:
    description: 'Release $RELEASE_VERSION'
    tag_name: '$RELEASE_VERSION'
    ref: '$CI_COMMIT_SHA'
